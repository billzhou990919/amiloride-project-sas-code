data cms.allcvddrug2015;
  set partd15.pde_file_2015(keep=bene_id srvc_dt days_suply_num gnn);
  if upcase(gnn) in: ('AMILORIDE', 'EPLERENONE', ‘SPIRONOLACTONE’, ‘TRIAMTERENE’, 'BENAZEPRIL', 'CAPTOPRIL', 'CILAZAPRIL', 'ENALAPRIL', 'ENALAPRILAT', 'FOSINOPRIL', 'LISINOPRIL', 'MOEXIPRIL', 'PERINDOPRIL', 'QUINAPRIL', 'RAMIPRIL', 'TRANDOLAPRIL', 'SPIRAPRIL', 'TEMOCAPRIL', 'ZOFENOPRIL', 'IMIDAPRIL', 'DELAPRIL',
'VALSARTAN', 'OLMESARTAN', 'EPROSARTAN', 'TELMISARTAN', 'IRBESARTAN', 'TASOSARTAN', 'AZILSARTAN', 'FIMASARTAN', 'CANDESARTAN', 'LOSARTAN', 'NITROGLYCERIN', 'GLYCERYL TRINITRATE', 'ISOSORBIDE DINITRATE', 'ISOSORBIDE MONONITRATE', 'ERYTHRITYL TETRANITRATE', 'PENTAERYTHRITOL TETRANITRATE', 'NICORANDIL', 'MOLSIDOMINE', 'TRAPIDIL', 'IMOLAMINE', 'HEXOBENDINE',
'QUINIDINE', 'PROCAINAMIDE', 'DISOPYRAMIDE', 'SPARTEINE', 'AJMALINE', 'PRAJMALINE', 'LORAJMINE', 'HYDROQUINIDINE', 'LIDOCAINE', 'MEXILETINE', 'TOCAINIDE', 'APRINDINE', 'PROPAFENONE', 'FLECAINIDE', 'LORCAINIDE', 'ENCAINIDE', 'ETHACIZINE', 'AMIODARONE', 'BRETYLIUM', 'BUNAFTINE', 'DOFETILIDE', 'IBUTILIDE', 'TEDISAMIL', 
'DRONEDARONE', 'MORACIZINE', 'CIBENZOLINE', 'VERNAKALANT', 'DITAZOLE', 'CLORICROMEN', 'PICOTAMIDE', 'CLOPIDOGREL', 'TICLOPIDINE', 'DIPYRIDAMOLE', 'CARBASALATE CALCIUM', 'EPOPROSTENOL', 'INDOBUFEN', 'ILOPROST', 'ABCIXIMAB', 'ALOXIPRIN', 'EPTIFIBATIDE', 'TIROFIBAN', 'TRIFLUSAL', 'BERAPROST', 'TREPROSTINIL', 'PRASUGREL', 'CILOSTAZOL', 
'TICAGRELOR', 'CANGRELOR', 'VORAPAXAR', 'SELEXIPAG', 'ALPRENOLOL', 'OXPRENOLOL', 'PINDOLOL', 'PROPRANOLOL', 'TIMOLOL', 'SOTALOL', 'NADOLOL', 'MEPINDOLOL', 'CARTEOLOL', 'TERTATOLOL', 'BOPINDOLOL', 'BUPRANOLOL', 'PENBUTOLOL', 'CLORANOLOL', 'PRACTOLOL', 'METOPROLOL', 'ATENOLOL', 'ACEBUTOLOL', 'BETAXOLOL',
'BEVANTOLOL', 'BISOPROLOL', 'CELIPROLOL', 'ESMOLOL', 'EPANOLOL', 'S-ATENOLOL', 'NEBIVOLOL', 'TALINOLOL', 'LANDIOLOL', 'LABETALOL', 'CARVEDILOL', 'AMLODIPINE', 'FELODIPINE', 'ISRADIPINE', 'NICARDIPINE', 'NIFEDIPINE', 'NIMODIPINE', 'NISOLDIPINE', 'NITRENDIPINE', 'LACIDIPINE', 'NILVADIPINE', 'MANIDIPINE', 'BARNIDIPINE', 
'LERCANIDIPINE', 'CILNIDIPINE', 'BENIDIPINE', 'CLEVIDIPINE', 'MIBEFRADIL', 'FENDILINE', 'BEPRIDIL', 'LIDOFLAZINE', 'PERHEXILINE','BENDROFLUMETHIAZIDE', 'HYDROFLUMETHIAZIDE', 'HYDROCHLOROTHIAZIDE', 'CHLOROTHIAZIDE', 'POLYTHIAZIDE', 'TRICHLORMETHIAZIDE', 'CYCLOPENTHIAZIDE', 'METHYCLOTHIAZIDE', 'CYCLOTHIAZIDE', 
'MEBUTIZIDE', 'QUINETHAZONE', 'CLOPAMIDE');
run;
data cms.allcvddrug2016;
  set partd16.pde_file_2016(keep=bene_id srvc_dt days_suply_num gnn);
  if upcase(gnn) in: ('AMILORIDE', 'EPLERENONE', ‘SPIRONOLACTONE’, ‘TRIAMTERENE’, 'BENAZEPRIL', 'CAPTOPRIL', 'CILAZAPRIL', 'ENALAPRIL', 'ENALAPRILAT', 'FOSINOPRIL', 'LISINOPRIL', 'MOEXIPRIL', 'PERINDOPRIL', 'QUINAPRIL', 'RAMIPRIL', 'TRANDOLAPRIL', 'SPIRAPRIL', 'TEMOCAPRIL', 'ZOFENOPRIL', 'IMIDAPRIL', 'DELAPRIL',
'VALSARTAN', 'OLMESARTAN', 'EPROSARTAN', 'TELMISARTAN', 'IRBESARTAN', 'TASOSARTAN', 'AZILSARTAN', 'FIMASARTAN', 'CANDESARTAN', 'LOSARTAN', 'NITROGLYCERIN', 'GLYCERYL TRINITRATE', 'ISOSORBIDE DINITRATE', 'ISOSORBIDE MONONITRATE', 'ERYTHRITYL TETRANITRATE', 'PENTAERYTHRITOL TETRANITRATE', 'NICORANDIL', 'MOLSIDOMINE', 'TRAPIDIL', 'IMOLAMINE', 'HEXOBENDINE',
'QUINIDINE', 'PROCAINAMIDE', 'DISOPYRAMIDE', 'SPARTEINE', 'AJMALINE', 'PRAJMALINE', 'LORAJMINE', 'HYDROQUINIDINE', 'LIDOCAINE', 'MEXILETINE', 'TOCAINIDE', 'APRINDINE', 'PROPAFENONE', 'FLECAINIDE', 'LORCAINIDE', 'ENCAINIDE', 'ETHACIZINE', 'AMIODARONE', 'BRETYLIUM', 'BUNAFTINE', 'DOFETILIDE', 'IBUTILIDE', 'TEDISAMIL', 
'DRONEDARONE', 'MORACIZINE', 'CIBENZOLINE', 'VERNAKALANT', 'DITAZOLE', 'CLORICROMEN', 'PICOTAMIDE', 'CLOPIDOGREL', 'TICLOPIDINE', 'DIPYRIDAMOLE', 'CARBASALATE CALCIUM', 'EPOPROSTENOL', 'INDOBUFEN', 'ILOPROST', 'ABCIXIMAB', 'ALOXIPRIN', 'EPTIFIBATIDE', 'TIROFIBAN', 'TRIFLUSAL', 'BERAPROST', 'TREPROSTINIL', 'PRASUGREL', 'CILOSTAZOL', 
'TICAGRELOR', 'CANGRELOR', 'VORAPAXAR', 'SELEXIPAG', 'ALPRENOLOL', 'OXPRENOLOL', 'PINDOLOL', 'PROPRANOLOL', 'TIMOLOL', 'SOTALOL', 'NADOLOL', 'MEPINDOLOL', 'CARTEOLOL', 'TERTATOLOL', 'BOPINDOLOL', 'BUPRANOLOL', 'PENBUTOLOL', 'CLORANOLOL', 'PRACTOLOL', 'METOPROLOL', 'ATENOLOL', 'ACEBUTOLOL', 'BETAXOLOL',
'BEVANTOLOL', 'BISOPROLOL', 'CELIPROLOL', 'ESMOLOL', 'EPANOLOL', 'S-ATENOLOL', 'NEBIVOLOL', 'TALINOLOL', 'LANDIOLOL', 'LABETALOL', 'CARVEDILOL', 'AMLODIPINE', 'FELODIPINE', 'ISRADIPINE', 'NICARDIPINE', 'NIFEDIPINE', 'NIMODIPINE', 'NISOLDIPINE', 'NITRENDIPINE', 'LACIDIPINE', 'NILVADIPINE', 'MANIDIPINE', 'BARNIDIPINE', 
'LERCANIDIPINE', 'CILNIDIPINE', 'BENIDIPINE', 'CLEVIDIPINE', 'MIBEFRADIL', 'FENDILINE', 'BEPRIDIL', 'LIDOFLAZINE', 'PERHEXILINE','BENDROFLUMETHIAZIDE', 'HYDROFLUMETHIAZIDE', 'HYDROCHLOROTHIAZIDE', 'CHLOROTHIAZIDE', 'POLYTHIAZIDE', 'TRICHLORMETHIAZIDE', 'CYCLOPENTHIAZIDE', 'METHYCLOTHIAZIDE', 'CYCLOTHIAZIDE', 
'MEBUTIZIDE', 'QUINETHAZONE', 'CLOPAMIDE');
run;
data cms.allcvddrug2017;
  set partd17.pde_file_2017(keep=bene_id srvc_dt days_suply_num gnn);
  if upcase(gnn) in: ('AMILORIDE', 'EPLERENONE', ‘SPIRONOLACTONE’, ‘TRIAMTERENE’, 'BENAZEPRIL', 'CAPTOPRIL', 'CILAZAPRIL', 'ENALAPRIL', 'ENALAPRILAT', 'FOSINOPRIL', 'LISINOPRIL', 'MOEXIPRIL', 'PERINDOPRIL', 'QUINAPRIL', 'RAMIPRIL', 'TRANDOLAPRIL', 'SPIRAPRIL', 'TEMOCAPRIL', 'ZOFENOPRIL', 'IMIDAPRIL', 'DELAPRIL',
'VALSARTAN', 'OLMESARTAN', 'EPROSARTAN', 'TELMISARTAN', 'IRBESARTAN', 'TASOSARTAN', 'AZILSARTAN', 'FIMASARTAN', 'CANDESARTAN', 'LOSARTAN', 'NITROGLYCERIN', 'GLYCERYL TRINITRATE', 'ISOSORBIDE DINITRATE', 'ISOSORBIDE MONONITRATE', 'ERYTHRITYL TETRANITRATE', 'PENTAERYTHRITOL TETRANITRATE', 'NICORANDIL', 'MOLSIDOMINE', 'TRAPIDIL', 'IMOLAMINE', 'HEXOBENDINE',
'QUINIDINE', 'PROCAINAMIDE', 'DISOPYRAMIDE', 'SPARTEINE', 'AJMALINE', 'PRAJMALINE', 'LORAJMINE', 'HYDROQUINIDINE', 'LIDOCAINE', 'MEXILETINE', 'TOCAINIDE', 'APRINDINE', 'PROPAFENONE', 'FLECAINIDE', 'LORCAINIDE', 'ENCAINIDE', 'ETHACIZINE', 'AMIODARONE', 'BRETYLIUM', 'BUNAFTINE', 'DOFETILIDE', 'IBUTILIDE', 'TEDISAMIL', 
'DRONEDARONE', 'MORACIZINE', 'CIBENZOLINE', 'VERNAKALANT', 'DITAZOLE', 'CLORICROMEN', 'PICOTAMIDE', 'CLOPIDOGREL', 'TICLOPIDINE', 'DIPYRIDAMOLE', 'CARBASALATE CALCIUM', 'EPOPROSTENOL', 'INDOBUFEN', 'ILOPROST', 'ABCIXIMAB', 'ALOXIPRIN', 'EPTIFIBATIDE', 'TIROFIBAN', 'TRIFLUSAL', 'BERAPROST', 'TREPROSTINIL', 'PRASUGREL', 'CILOSTAZOL', 
'TICAGRELOR', 'CANGRELOR', 'VORAPAXAR', 'SELEXIPAG', 'ALPRENOLOL', 'OXPRENOLOL', 'PINDOLOL', 'PROPRANOLOL', 'TIMOLOL', 'SOTALOL', 'NADOLOL', 'MEPINDOLOL', 'CARTEOLOL', 'TERTATOLOL', 'BOPINDOLOL', 'BUPRANOLOL', 'PENBUTOLOL', 'CLORANOLOL', 'PRACTOLOL', 'METOPROLOL', 'ATENOLOL', 'ACEBUTOLOL', 'BETAXOLOL',
'BEVANTOLOL', 'BISOPROLOL', 'CELIPROLOL', 'ESMOLOL', 'EPANOLOL', 'S-ATENOLOL', 'NEBIVOLOL', 'TALINOLOL', 'LANDIOLOL', 'LABETALOL', 'CARVEDILOL', 'AMLODIPINE', 'FELODIPINE', 'ISRADIPINE', 'NICARDIPINE', 'NIFEDIPINE', 'NIMODIPINE', 'NISOLDIPINE', 'NITRENDIPINE', 'LACIDIPINE', 'NILVADIPINE', 'MANIDIPINE', 'BARNIDIPINE', 
'LERCANIDIPINE', 'CILNIDIPINE', 'BENIDIPINE', 'CLEVIDIPINE', 'MIBEFRADIL', 'FENDILINE', 'BEPRIDIL', 'LIDOFLAZINE', 'PERHEXILINE','BENDROFLUMETHIAZIDE', 'HYDROFLUMETHIAZIDE', 'HYDROCHLOROTHIAZIDE', 'CHLOROTHIAZIDE', 'POLYTHIAZIDE', 'TRICHLORMETHIAZIDE', 'CYCLOPENTHIAZIDE', 'METHYCLOTHIAZIDE', 'CYCLOTHIAZIDE', 
'MEBUTIZIDE', 'QUINETHAZONE', 'CLOPAMIDE');
run;
data cms.allcvddrug2018;
  set partd18.pde_file_2018(keep=bene_id srvc_dt days_suply_num gnn);
  if upcase(gnn) in: ('AMILORIDE', 'EPLERENONE', ‘SPIRONOLACTONE’, ‘TRIAMTERENE’, 'BENAZEPRIL', 'CAPTOPRIL', 'CILAZAPRIL', 'ENALAPRIL', 'ENALAPRILAT', 'FOSINOPRIL', 'LISINOPRIL', 'MOEXIPRIL', 'PERINDOPRIL', 'QUINAPRIL', 'RAMIPRIL', 'TRANDOLAPRIL', 'SPIRAPRIL', 'TEMOCAPRIL', 'ZOFENOPRIL', 'IMIDAPRIL', 'DELAPRIL',
'VALSARTAN', 'OLMESARTAN', 'EPROSARTAN', 'TELMISARTAN', 'IRBESARTAN', 'TASOSARTAN', 'AZILSARTAN', 'FIMASARTAN', 'CANDESARTAN', 'LOSARTAN', 'NITROGLYCERIN', 'GLYCERYL TRINITRATE', 'ISOSORBIDE DINITRATE', 'ISOSORBIDE MONONITRATE', 'ERYTHRITYL TETRANITRATE', 'PENTAERYTHRITOL TETRANITRATE', 'NICORANDIL', 'MOLSIDOMINE', 'TRAPIDIL', 'IMOLAMINE', 'HEXOBENDINE',
'QUINIDINE', 'PROCAINAMIDE', 'DISOPYRAMIDE', 'SPARTEINE', 'AJMALINE', 'PRAJMALINE', 'LORAJMINE', 'HYDROQUINIDINE', 'LIDOCAINE', 'MEXILETINE', 'TOCAINIDE', 'APRINDINE', 'PROPAFENONE', 'FLECAINIDE', 'LORCAINIDE', 'ENCAINIDE', 'ETHACIZINE', 'AMIODARONE', 'BRETYLIUM', 'BUNAFTINE', 'DOFETILIDE', 'IBUTILIDE', 'TEDISAMIL', 
'DRONEDARONE', 'MORACIZINE', 'CIBENZOLINE', 'VERNAKALANT', 'DITAZOLE', 'CLORICROMEN', 'PICOTAMIDE', 'CLOPIDOGREL', 'TICLOPIDINE', 'DIPYRIDAMOLE', 'CARBASALATE CALCIUM', 'EPOPROSTENOL', 'INDOBUFEN', 'ILOPROST', 'ABCIXIMAB', 'ALOXIPRIN', 'EPTIFIBATIDE', 'TIROFIBAN', 'TRIFLUSAL', 'BERAPROST', 'TREPROSTINIL', 'PRASUGREL', 'CILOSTAZOL', 
'TICAGRELOR', 'CANGRELOR', 'VORAPAXAR', 'SELEXIPAG', 'ALPRENOLOL', 'OXPRENOLOL', 'PINDOLOL', 'PROPRANOLOL', 'TIMOLOL', 'SOTALOL', 'NADOLOL', 'MEPINDOLOL', 'CARTEOLOL', 'TERTATOLOL', 'BOPINDOLOL', 'BUPRANOLOL', 'PENBUTOLOL', 'CLORANOLOL', 'PRACTOLOL', 'METOPROLOL', 'ATENOLOL', 'ACEBUTOLOL', 'BETAXOLOL',
'BEVANTOLOL', 'BISOPROLOL', 'CELIPROLOL', 'ESMOLOL', 'EPANOLOL', 'S-ATENOLOL', 'NEBIVOLOL', 'TALINOLOL', 'LANDIOLOL', 'LABETALOL', 'CARVEDILOL', 'AMLODIPINE', 'FELODIPINE', 'ISRADIPINE', 'NICARDIPINE', 'NIFEDIPINE', 'NIMODIPINE', 'NISOLDIPINE', 'NITRENDIPINE', 'LACIDIPINE', 'NILVADIPINE', 'MANIDIPINE', 'BARNIDIPINE', 
'LERCANIDIPINE', 'CILNIDIPINE', 'BENIDIPINE', 'CLEVIDIPINE', 'MIBEFRADIL', 'FENDILINE', 'BEPRIDIL', 'LIDOFLAZINE', 'PERHEXILINE','BENDROFLUMETHIAZIDE', 'HYDROFLUMETHIAZIDE', 'HYDROCHLOROTHIAZIDE', 'CHLOROTHIAZIDE', 'POLYTHIAZIDE', 'TRICHLORMETHIAZIDE', 'CYCLOPENTHIAZIDE', 'METHYCLOTHIAZIDE', 'CYCLOTHIAZIDE', 
'MEBUTIZIDE', 'QUINETHAZONE', 'CLOPAMIDE');
run;
data cms.allcvddrug2019;
  set partd19.pde_file_2019(keep=bene_id srvc_dt days_suply_num gnn);
  if upcase(gnn) in: ('AMILORIDE', 'EPLERENONE', ‘SPIRONOLACTONE’, ‘TRIAMTERENE’, 'BENAZEPRIL', 'CAPTOPRIL', 'CILAZAPRIL', 'ENALAPRIL', 'ENALAPRILAT', 'FOSINOPRIL', 'LISINOPRIL', 'MOEXIPRIL', 'PERINDOPRIL', 'QUINAPRIL', 'RAMIPRIL', 'TRANDOLAPRIL', 'SPIRAPRIL', 'TEMOCAPRIL', 'ZOFENOPRIL', 'IMIDAPRIL', 'DELAPRIL',
'VALSARTAN', 'OLMESARTAN', 'EPROSARTAN', 'TELMISARTAN', 'IRBESARTAN', 'TASOSARTAN', 'AZILSARTAN', 'FIMASARTAN', 'CANDESARTAN', 'LOSARTAN', 'NITROGLYCERIN', 'GLYCERYL TRINITRATE', 'ISOSORBIDE DINITRATE', 'ISOSORBIDE MONONITRATE', 'ERYTHRITYL TETRANITRATE', 'PENTAERYTHRITOL TETRANITRATE', 'NICORANDIL', 'MOLSIDOMINE', 'TRAPIDIL', 'IMOLAMINE', 'HEXOBENDINE',
'QUINIDINE', 'PROCAINAMIDE', 'DISOPYRAMIDE', 'SPARTEINE', 'AJMALINE', 'PRAJMALINE', 'LORAJMINE', 'HYDROQUINIDINE', 'LIDOCAINE', 'MEXILETINE', 'TOCAINIDE', 'APRINDINE', 'PROPAFENONE', 'FLECAINIDE', 'LORCAINIDE', 'ENCAINIDE', 'ETHACIZINE', 'AMIODARONE', 'BRETYLIUM', 'BUNAFTINE', 'DOFETILIDE', 'IBUTILIDE', 'TEDISAMIL', 
'DRONEDARONE', 'MORACIZINE', 'CIBENZOLINE', 'VERNAKALANT', 'DITAZOLE', 'CLORICROMEN', 'PICOTAMIDE', 'CLOPIDOGREL', 'TICLOPIDINE', 'DIPYRIDAMOLE', 'CARBASALATE CALCIUM', 'EPOPROSTENOL', 'INDOBUFEN', 'ILOPROST', 'ABCIXIMAB', 'ALOXIPRIN', 'EPTIFIBATIDE', 'TIROFIBAN', 'TRIFLUSAL', 'BERAPROST', 'TREPROSTINIL', 'PRASUGREL', 'CILOSTAZOL', 
'TICAGRELOR', 'CANGRELOR', 'VORAPAXAR', 'SELEXIPAG', 'ALPRENOLOL', 'OXPRENOLOL', 'PINDOLOL', 'PROPRANOLOL', 'TIMOLOL', 'SOTALOL', 'NADOLOL', 'MEPINDOLOL', 'CARTEOLOL', 'TERTATOLOL', 'BOPINDOLOL', 'BUPRANOLOL', 'PENBUTOLOL', 'CLORANOLOL', 'PRACTOLOL', 'METOPROLOL', 'ATENOLOL', 'ACEBUTOLOL', 'BETAXOLOL',
'BEVANTOLOL', 'BISOPROLOL', 'CELIPROLOL', 'ESMOLOL', 'EPANOLOL', 'S-ATENOLOL', 'NEBIVOLOL', 'TALINOLOL', 'LANDIOLOL', 'LABETALOL', 'CARVEDILOL', 'AMLODIPINE', 'FELODIPINE', 'ISRADIPINE', 'NICARDIPINE', 'NIFEDIPINE', 'NIMODIPINE', 'NISOLDIPINE', 'NITRENDIPINE', 'LACIDIPINE', 'NILVADIPINE', 'MANIDIPINE', 'BARNIDIPINE', 
'LERCANIDIPINE', 'CILNIDIPINE', 'BENIDIPINE', 'CLEVIDIPINE', 'MIBEFRADIL', 'FENDILINE', 'BEPRIDIL', 'LIDOFLAZINE', 'PERHEXILINE','BENDROFLUMETHIAZIDE', 'HYDROFLUMETHIAZIDE', 'HYDROCHLOROTHIAZIDE', 'CHLOROTHIAZIDE', 'POLYTHIAZIDE', 'TRICHLORMETHIAZIDE', 'CYCLOPENTHIAZIDE', 'METHYCLOTHIAZIDE', 'CYCLOTHIAZIDE', 
'MEBUTIZIDE', 'QUINETHAZONE', 'CLOPAMIDE');
run;

/*getting mbsf files*/
proc sql;
    create table cms.cvdmbsf15 as
    select bene_id,sample_group,bene_birth_dt from mbsf15.mbsf_abcd_summary_2015
    where bene_id in (select bene_id from cms.allcvddrug2015);
Quit;
proc sql;
    create table cms.cvdmbsf16 as
    select bene_id,sample_group,bene_birth_dt from mbsf16.mbsf_abcd_summary_2016
    where bene_id in (select bene_id from cms.allcvddrug2016);
Quit;
proc sql;
    create table cms.cvdmbsf17 as
    select bene_id,sample_group,bene_birth_dt from mbsf17.mbsf_abcd_summary_2017
    where bene_id in (select bene_id from cms.allcvddrug2017);
Quit;
proc sql;
    create table cms.cvdmbsf18 as
    select bene_id,sample_group,bene_birth_dt from mbsf18.mbsf_abcd_summary_2018
    where bene_id in (select bene_id from cms.allcvddrug2018);
Quit;
proc sql;
    create table cms.cvdmbsf19 as
    select bene_id,sample_group,bene_birth_dt from mbsf19.mbsf_abcd_summary_2019
    where bene_id in (select bene_id from cms.allcvddrug2019);
Quit;


proc sort data=cms.cvdmbsf15 out=cms.cvdmbsf15v2 nodupkey;
    by bene_id;
run;
proc sort data=cms.cvdmbsf16 out=cms.cvdmbsf16v2 nodupkey;
    by bene_id;
run;
proc sort data=cms.cvdmbsf17 out=cms.cvdmbsf17v2 nodupkey;
    by bene_id;
run;
proc sort data=cms.cvdmbsf18 out=cms.cvdmbsf18v2 nodupkey;
    by bene_id;
run;
proc sort data=cms.cvdmbsf19 out=cms.cvdmbsf19v2 nodupkey;
    by bene_id;
run;

data cms.cvdmbsf15v2;
  set cms.cvdmbsf15v2;
  year = 2015;
run;
data cms.cvdmbsf16v2;
  set cms.cvdmbsf16v2;
  year = 2016;
run;
data cms.cvdmbsf17v2;
  set cms.cvdmbsf17v2;
  year = 2017;
run;
data cms.cvdmbsf18v2;
  set cms.cvdmbsf18v2;
  year = 2018;
run;
data cms.cvdmbsf19v2;
  set cms.cvdmbsf19v2;
  year = 2019;
run;

data cms.cvdmbsf15to19;
  set cms.cvdmbsf15v2 cms.cvdmbsf16v2 cms.cvdmbsf17v2 cms.cvdmbsf18v2 cms.cvdmbsf19v2;
run;

data cms.cvddrug15to19;
  set cms.allcvddrug2015 cms.allcvddrug2016 cms.allcvddrug2017 cms.allcvddrug2018 cms.allcvddrug2019;
run;

/*exclude sample group not in 20% */
data toexclude;
  set cms.cvdmbsf15to19;
  if sample_group = ' ';
run;
proc sql;
   create table toexclude_nodup as
   select distinct bene_id
   from toexclude
   group by bene_id;
quit;

proc sql;
    create table cms.cvddrug15to19v2 as
    select * from cms.cvddrug15to19
    where bene_id not in (select bene_id from toexclude_nodup);
Quit;

/*get first cvd drug claims of each user (2016 to 2019) and get day0*/
data cms.cvddrug16to19;
  set cms.cvddrug15to19v2;
  if year(srvc_dt) ne '2015';
run;

proc sql;
    create table cms.cvd16to19day0 as
    select a.*
    from cms.cvddrug16to19 a
    inner join
        (select bene_id, min(srvc_dt) as index_date
         from cms.cvddrug16to19
         group by bene_id) b
    on a.bene_id = b.bene_id and a.srvc_dt = b.index_date;
quit;

proc sort data=cms.cvd16to19day0; 
    by bene_id;
run;
data cms.cvd16to19day0v2; 
    set cms.cvd16to19day0; 
    by bene_id;
    if first.bene_id; 
run;

proc sql;
   create table cvd15to19birthday as
   select distinct bene_id, bene_birth_dt
   from cms.cvdmbsf15to19;
quit;

proc sql;
   create table cms.cvd16to19day0v3 as
   select a.*
   from cms.cvd16to19day0v2 as a
   inner join cvd15to19birthday as b on a.bene_id = b.bene_id
   where intck('year', b.bene_birth_dt, a.srvc_dt) >= 66;
quit;

proc sql;
    create table cms.cvdmbsf15 as
    select * from mbsf15.mbsf_abcd_summary_2015
    where bene_id in (select bene_id from cms.cvd16to19day0v3);
Quit;
proc sql;
    create table cms.cvdmbsf16 as
    select * from mbsf16.mbsf_abcd_summary_2016
    where bene_id in (select bene_id from cms.cvd16to19day0v3);
Quit;
proc sql;
    create table cms.cvdmbsf17 as
    select * from mbsf17.mbsf_abcd_summary_2017
    where bene_id in (select bene_id from cms.cvd16to19day0v3);
Quit;
proc sql;
    create table cms.cvdmbsf18 as
    select * from mbsf18.mbsf_abcd_summary_2018
    where bene_id in (select bene_id from cms.cvd16to19day0v3);
Quit;
proc sql;
    create table cms.cvdmbsf19 as
    select * from mbsf19.mbsf_abcd_summary_2019
    where bene_id in (select bene_id from cms.cvd16to19day0v3);
Quit;

**CONTINUOUS ENROLLMENT;
%macro _5pbenesum( yr, indata);
data benesum&yr (keep = bene_id mdcr_entlmt_buyin_ind_01-mdcr_entlmt_buyin_ind_12 hmo_ind_01-hmo_ind_12  HMOIND_&yr BUYIN_&yr);
  set cms.&indata;
  HMOIND_&yr = compress(hmo_ind_01||hmo_ind_02||hmo_ind_03||hmo_ind_04||hmo_ind_05||hmo_ind_06||hmo_ind_07||hmo_ind_08||hmo_ind_09||hmo_ind_10||hmo_ind_11||hmo_ind_12, " ");
  BUYIN_&yr = compress(mdcr_entlmt_buyin_ind_01||mdcr_entlmt_buyin_ind_02||mdcr_entlmt_buyin_ind_03||mdcr_entlmt_buyin_ind_04||mdcr_entlmt_buyin_ind_05||mdcr_entlmt_buyin_ind_06||mdcr_entlmt_buyin_ind_07||mdcr_entlmt_buyin_ind_08||mdcr_entlmt_buyin_ind_09||mdcr_entlmt_buyin_ind_10||mdcr_entlmt_buyin_ind_11||mdcr_entlmt_buyin_ind_12, " ");
run;

proc sort data=benesum&yr; by bene_id; run;

Proc sql;
create table  benesum&yr._1 as
select a.bene_id, a.HMOIND_&yr, a.BUYIN_&yr
from benesum&yr as a, cms.cvd16to19day0v3 as b
where a.bene_id = b.bene_id;
quit;

Proc sort data = benesum&yr._1 nodupkey; by bene_id; run;

%mend _5pbenesum;

%_5pbenesum (2015, cvdmbsf15);	
%_5pbenesum (2016, cvdmbsf16);	
%_5pbenesum (2017, cvdmbsf17);	
%_5pbenesum (2018, cvdmbsf18);		
%_5pbenesum (2019, cvdmbsf19);			

data benesum_2015_2019 ;				
  merge benesum2015_1 benesum2016_1 benesum2017_1 benesum2018_1 benesum2019_1;
  by bene_id;
run;

Proc sql;
create table raw_cohort1 as
select * 
from  benesum_2015_2019 as a,  cms.cvd16to19day0v3 as b
where a.bene_id = b.bene_id;
quit;

data  raw_cohort2; 
  set raw_cohort1;

   HMOIND = HMOIND_2015||HMOIND_2016||HMOIND_2017||HMOIND_2018||HMOIND_2019;
   BUYIN = BUYIN_2015||BUYIN_2016||BUYIN_2017||BUYIN_2018||BUYIN_2019;

	PartAB365 = 0;						
	HMO365=0;				

    Start  = (year(srvc_dt)-2015)*12 + month(srvc_dt) -12;
	end  = (year(srvc_dt)-2015)*12 + month(srvc_dt) - 1;

	**365 days prior to index date;
	do i = start to end until (substr (BUYIN,i,1) not in ("3","C"));
			if substr(BUYIN,i,1)in ("3","C")then PartAB365 + 1; end;

	do j=start to end until (substr(HMOIND,j,1)not in ("0"));
		if substr(HMOIND,j,1) in ("0")then HMO365+1; end;	

	if partAB365 = (end-start)+1 and hmo365 = (end-start) + 1 then cont_12mon = 1; else cont_12mon = 0;

run;


data raw_cohort3; 	
set raw_cohort2;
where cont_12mon = 1;
run;
















data _null_;
    set cms.cvd16to19day0v2   nobs=nobs_var;
    call symput('obs_count', nobs_var);
    stop;
run;

proc sql noprint;
    select count(distinct bene_id) into :unique_patients
    from cms.cvd16to19day0v2;
quit;

%put Number of Observations: &obs_count;
%put Number of Unique Patients (bene_id): &unique_patients;




















