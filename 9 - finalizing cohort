proc sql;
    create table cms.analytical_cohort as
    select * from cms.all_drug_claims
    where bene_id in (select bene_id from cms.study_cohort);
quit;

Data cms.analytical_cohort;
Set cms.analytical_cohort;
Supp_end = srvc_dt + days_suply_num;
run;

proc sql;
    create table max_supp_end as
    select bene_id, max(supp_end) as discontinuation
    from cms.analytical_cohort
    group by bene_id;
quit;

/* Step 2: Merge the max value with the original dataset */
data cms.analytical_cohort;
    merge cms.study_cohort(in=a) max_supp_end(in=b);
    by bene_id;

    /* Keep all rows from the original dataset */
    if a;
run;

/* Optional: Cleanup by deleting the temporary table */
proc datasets library=work nolist;
    delete max_supp_end;
run;
Quit;


data cms.study_cohort;
   set cms.analytical_cohort;
   by bene_id;
   if first.bene_id;
   keep bene_id gndr_cd amiloride index_date birth_date discontinuation bn gnn;
run;


proc sql;
   create table cms.study_cohort as
   select a.*, b.change_start, b.change_detected
   from cms.study_cohort as a
   left join cms.unique_drug_user_switching as b
   on a.bene_id = b.bene_id;
quit;


data cms.analytical_cohort;
    set cms.analytical_cohort_nodup;
    /* Calculate surv_time based on conditions */
    if earliest_pd ne . then surv_time = earliest_pd - index_date;
    else surv_time = discontinuation - index_date;
run;
