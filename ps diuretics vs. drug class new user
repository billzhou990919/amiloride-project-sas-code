data _null_;
    set cms.study_cohort_2017_cvd   nobs=nobs_var;
    call symput('obs_count', nobs_var);
    stop;
run;

proc sql noprint;
    select count(distinct bene_id) into :unique_patients
    from cms.study_cohort_2017_cvd;
quit;

%put Number of Observationsvvvvv: &obs_count;
%put Number of Unique Patients (bene_id): &unique_patients;

data cms.alldrug2016;
set partd16.pde_file_2016;
keep bene_id gndr_cd srvc_dt days_suply_num bn gnn;
run;

data cms.cvd_drug_claims_2016;
    set cms.alldrug2016;
    if upcase(gnn) in: ('AMILORIDE', 'EPLERENONE', ‘SPIRONOLACTONE’, ‘TRIAMTERENE’, 'BENAZEPRIL', 'CAPTOPRIL', 'CILAZAPRIL', 'ENALAPRIL', 'ENALAPRILAT', 'FOSINOPRIL', 'LISINOPRIL', 'MOEXIPRIL', 'PERINDOPRIL', 'QUINAPRIL', 'RAMIPRIL', 'TRANDOLAPRIL', 'SPIRAPRIL', 'TEMOCAPRIL', 'ZOFENOPRIL', 'IMIDAPRIL', 'DELAPRIL',
'VALSARTAN', 'OLMESARTAN', 'EPROSARTAN', 'TELMISARTAN', 'IRBESARTAN', 'TASOSARTAN', 'AZILSARTAN', 'FIMASARTAN', 'CANDESARTAN', 'LOSARTAN', 'NITROGLYCERIN', 'GLYCERYL TRINITRATE', 'ISOSORBIDE DINITRATE', 'ISOSORBIDE MONONITRATE', 'ERYTHRITYL TETRANITRATE', 'PENTAERYTHRITOL TETRANITRATE', 'NICORANDIL', 'MOLSIDOMINE', 'TRAPIDIL', 'IMOLAMINE', 'HEXOBENDINE',
'QUINIDINE', 'PROCAINAMIDE', 'DISOPYRAMIDE', 'SPARTEINE', 'AJMALINE', 'PRAJMALINE', 'LORAJMINE', 'HYDROQUINIDINE', 'LIDOCAINE', 'MEXILETINE', 'TOCAINIDE', 'APRINDINE', 'PROPAFENONE', 'FLECAINIDE', 'LORCAINIDE', 'ENCAINIDE', 'ETHACIZINE', 'AMIODARONE', 'BRETYLIUM', 'BUNAFTINE', 'DOFETILIDE', 'IBUTILIDE', 'TEDISAMIL', 
'DRONEDARONE', 'MORACIZINE', 'CIBENZOLINE', 'VERNAKALANT', 'DITAZOLE', 'CLORICROMEN', 'PICOTAMIDE', 'CLOPIDOGREL', 'TICLOPIDINE', 'DIPYRIDAMOLE', 'CARBASALATE CALCIUM', 'EPOPROSTENOL', 'INDOBUFEN', 'ILOPROST', 'ABCIXIMAB', 'ALOXIPRIN', 'EPTIFIBATIDE', 'TIROFIBAN', 'TRIFLUSAL', 'BERAPROST', 'TREPROSTINIL', 'PRASUGREL', 'CILOSTAZOL', 
'TICAGRELOR', 'CANGRELOR', 'VORAPAXAR', 'SELEXIPAG', 'ALPRENOLOL', 'OXPRENOLOL', 'PINDOLOL', 'PROPRANOLOL', 'TIMOLOL', 'SOTALOL', 'NADOLOL', 'MEPINDOLOL', 'CARTEOLOL', 'TERTATOLOL', 'BOPINDOLOL', 'BUPRANOLOL', 'PENBUTOLOL', 'CLORANOLOL', 'PRACTOLOL', 'METOPROLOL', 'ATENOLOL', 'ACEBUTOLOL', 'BETAXOLOL',
'BEVANTOLOL', 'BISOPROLOL', 'CELIPROLOL', 'ESMOLOL', 'EPANOLOL', 'S-ATENOLOL', 'NEBIVOLOL', 'TALINOLOL', 'LANDIOLOL', 'LABETALOL', 'CARVEDILOL', 'AMLODIPINE', 'FELODIPINE', 'ISRADIPINE', 'NICARDIPINE', 'NIFEDIPINE', 'NIMODIPINE', 'NISOLDIPINE', 'NITRENDIPINE', 'LACIDIPINE', 'NILVADIPINE', 'MANIDIPINE', 'BARNIDIPINE', 
'LERCANIDIPINE', 'CILNIDIPINE', 'BENIDIPINE', 'CLEVIDIPINE', 'MIBEFRADIL', 'FENDILINE', 'BEPRIDIL', 'LIDOFLAZINE', 'PERHEXILINE','BENDROFLUMETHIAZIDE', 'HYDROFLUMETHIAZIDE', 'HYDROCHLOROTHIAZIDE', 'CHLOROTHIAZIDE', 'POLYTHIAZIDE', 'TRICHLORMETHIAZIDE', 'CYCLOPENTHIAZIDE', 'METHYCLOTHIAZIDE', 'CYCLOTHIAZIDE', 
'MEBUTIZIDE', 'QUINETHAZONE', 'CLOPAMIDE');
run;

proc sql;
    create table exclude_individuals as
    select distinct a.bene_id
    from cms.study_cohort_2017_cvd as a, cms.cvd_drug_claims_2016 as b
    where a.bene_id = b.bene_id
    and b.srvc_dt between (a.index_date - 365) and a.index_date;
Quit;
proc sql;
    create table cms.study_cohort_2017_cvd_new as
    select *
    from cms.study_cohort_2017_cvd
    where bene_id not in (select bene_id from exclude_individuals);
Quit;
